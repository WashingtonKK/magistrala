version: v1.0
name: CI Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: branch != 'master'
global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version go 1.20

# global_job_config:
#   prologue:
#     commands:
#       - checkout
#       - NPROC=$(nproc)
#       - GO_VERSION=1.19.4
#       - PROTOC_VERSION=23.3
#       - PROTOC_GEN_VERSION=v1.31.0
#       - PROTOC_GRPC_VERSION=v1.3.0     
#       - GOLANGCI_LINT_VERSION=v1.52.1 

blocks:
  - name: Setup
    dependencies: []
    task:
      jobs:
        - name: Setup Linter
          commands:
            - 'curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.53.3'
            - ./bin/golangci-lint version
            - cache store linter ./bin/golangci-lint
  
  - name: Setup Protobuf
    dependencies: []
    run:
      when: 'change_in([''/things/policies/auth.proto'', ''/users/policies/auth.proto''], {pipeline_file: ''ignore''})'
    task:
      jobs:
        - commands:
            - |
              setup_protoc() {
                PROTOC_ZIP=protoc-$PROTOC_VERSION-linux-x86_64.zip
                curl -0L https://github.com/google/protobuf/releases/download/v$PROTOC_VERSION/$PROTOC_ZIP -o $PROTOC_ZIP
                unzip -o $PROTOC_ZIP -d protoc3
                sudo mv protoc3/bin/* /usr/local/bin/
                sudo mv protoc3/include/* /usr/local/include/
                rm -f $PROTOC_ZIP
                go install google.golang.org/protobuf/cmd/protoc-gen-go@$PROTOC_GEN_VERSION
                go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@$PROTOC_GRPC_VERSION
                export PATH=$PATH:/usr/local/bin/protoc
                export PATH=$PATH:$HOME/go/bin
              }
            - setup_protoc
            - |
              for p in $(ls pkg/*/*.pb.go); do
                mv $p $p.tmp
              done     
            - protoc -I. --go_out=. --go_opt=paths=source_relative pkg/messaging/*.proto
            - protoc -I. --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative users/policies/*.proto
            - protoc -I. --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative things/policies/*.proto
            - "for p in $(ls pkg/*/*.pb.go); do\n  if ! cmp -s $p $p.tmp; then\n  \techo \"Proto file and generated Go file $p are out of sync!\"\n  \texit 1\n \tfi\ndone \n"
            - echo "Compile check for rabbitmq..."
            - MF_BROKER_TYPE=rabbitmq make http
          name: Setup Protobuf  
#MQTT    
  - name: Lint and Test Mqtt
    dependencies:
      - Setup
      - Setup Protobuf
    run:
      when: 'change_in(''/mqtt/'', {pipeline_file: ''ignore''})'     
    task:
      jobs:
        - name: Lint Mqtt
          commands:
            - cd mqtt
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Mqtt
          commands:
            - cd mqtt
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
      env_vars: []
  - name: Build Mqtt
    dependencies:
      - Lint and Test Mqtt
    run:
      when: 'change_in(''/mqtt/'', {pipeline_file: ''ignore''})'
    task:
      jobs:
        - commands:
            - make mqtt
          name: Build Mqtt
  - name: Push Mqtt
    dependencies:
      - Build Mqtt
    run:
      when: 'change_in(''/mqtt/'', {pipeline_file: ''ignore''})'
    task:
      jobs:
        - commands:
            - docker push mainflux/mqtt
          name: Push Mqtt     
  - name: Lint and Test Http
    dependencies:
      - Setup Protobuf
    task:
      jobs:
        - name: Lint Http
          commands:
            - cd http
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Http
          commands:
            - cd http
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Http
    dependencies:
      - Lint and Test Http
    run:
      when: 'change_in(''/http/'', {pipeline_file: ''ignore''})'
    task:
      jobs:
        - commands:
            - make http
          name: Build Http
  - name: Push Http
    dependencies:
      - Build Http
    run:
      when: 'change_in(''/http/'', {pipeline_file: ''ignore''})'
    task:
      jobs:
        - commands:
            - docker push mainflux/http
          name: Push Http





##########
  - name: Test all
    dependencies:
      - Setup Protobuf
    run:
      when: "branch = 'master'"
    task:
      jobs:
        - commands:
            - make test
          name: All test

  - name: Lint and Test Ws
    dependencies: []
    task:
      jobs:
        - name: Lint Wa
          commands:
            - cd ws
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Ws
          commands:
            - cd ws
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html      
  - name: Build Ws
    dependencies:
      - Lint and Test Ws
    run:
      when: "change_in('/ws/', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make ws
          name: Build Ws
  - name: Push Ws
    dependencies:
      - Build Ws
    run:
      when: "change_in('/ws/', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/ws
          name: Push Ws        


  - name: Lint and Test Coap
    dependencies: []
    task:
      jobs:
        - name: Lint Coap
          commands:
            - cd coap
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Coap
          commands:
            - cd coap
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html      
  - name: Build Coap
    dependencies:
      - Lint and Test Coap
    run:
      when: "change_in('/coap/', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make coap
          name: Build Coap
  - name: Push Coap
    dependencies:
      - Build Coap
    run:
      when: "change_in('/coap/', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/coap
          name: Push Coap               


  - name: Lint and Test Twins
    dependencies: []
    task:
      jobs:
        - name: Lint Twins
          commands:
            - cd twins
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Twins
          commands:
            - cd twins
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html        
  - name: Build Twins
    dependencies:
      - Lint and Test Twins
    run:
      when: "change_in('/twins', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make twins
          name: Build Twins
  - name: Push Twins
    dependencies:
      - Build Twins
    run:
      when: "change_in('/twins', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/twins
          name: Push Twins     

  - name: Lint and Test Users
    dependencies: []
    task:
      jobs:
        - name: Lint Users
          commands:
            - cd users
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Users
          commands:
            - cd users
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html     
  - name: Build Users
    dependencies:
      - Lint and Test Users
    run:
      when: "change_in('/users', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make users
          name: Build Users
  - name: Push Users
    dependencies:
      - Build Users
    run:
      when: "change_in('/users', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/users
          name: Push Users            



  - name: Lint and Test Things
    dependencies: []
    task:
      jobs:
        - name: Lint Things
          commands:
            - cd things
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Things
          commands:
            - cd things
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html       
  - name: Build Things
    dependencies:
      - Lint and Test Things
    run:
      when: "change_in('/things', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make things
          name: Build Things
  - name: Push Things
    dependencies:
      - Build Things
    run:
      when: "change_in('/things', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/things
          name: Push Things              


  - name: Lint and Test Lora
    dependencies: []
    task:
      jobs:
        - name: Lint Lora
          commands:
            - cd lora
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Lora
          commands:
            - cd lora
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Lora
    dependencies:
      - Lint and Test Lora
    run:
      when: "change_in('/lora', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make lora
          name: Build Lora
  - name: Push Lora
    dependencies:
      - Build Lora
    run:
      when: "change_in('/lora', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/lora
          name: Push Lora                

  - name: Lint and Test Consumers
    dependencies: []
    task:
      jobs:
        - name: Lint Consumers
          commands:
            - cd mqtt
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Consumers
          commands:
            - cd consumers
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Consumers
    dependencies:
      - Lint and Test Consumers
    run:
      when: "change_in('/consumers', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make consumers
          name: Build Consumers
  - name: Push Consumers
    dependencies:
      - Build Consumers
    run:
      when: "change_in('/consumers', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/consumers
          name: Push Consumers              



  - name: Lint and Test Logger
    dependencies: []
    task:
      jobs:
        - name: Lint Logger
          commands:
            - cd logger
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Mqtt
          commands:
            - cd logger
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Logger
    dependencies:
      - Lint and Test Logger
    run:
      when: "change_in('/logger', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make logger
          name: Build Logger
  - name: Push Logger
    dependencies:
      - Build Logger
    run:
      when: "change_in('/logger', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/logger
          name: Push Logger          


  - name: Lint Certs
    dependencies: []
    task:
      jobs:
        - name: Lint Certs
          commands:
            - cd certs
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Certs
          commands:
            - cd certs
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Certs
    dependencies:
      - Lint and Test Certs
    run:
      when: "change_in('/certs', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make certs
          name: Build Certs
  - name: Push Certs
    dependencies:
      - Build Certs
    run:
      when: "change_in('/certs', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/certs
          name: Push Certs    

  - name: Lint and Test Bootstrap
    dependencies: []
    task:
      jobs:
        - name: Lint Mqtt
          commands:
            - cd bootstrap
            - cache restore linter
            - ls -a
            - './bin/golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
        - name: Test Bootstrap
          commands:
            - cd bootstrap
            - go test ./... --race -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html
  - name: Build Bootstrap
    dependencies:
      - Lint and Test Bootstrap
    run:
      when: "change_in('/bootstrap', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - make bootstrap
          name: Build Bootstrap
  - name: Push Bootstrap
    dependencies:
      - Build Bootstrap
    run:
      when: "change_in('/bootstrap', {pipeline_file: 'ignore'})"
    task:
      jobs:
        - commands:
            - docker push mainflux/bootstrap
          name: Push Bootstrap
