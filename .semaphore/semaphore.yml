version: v1.0
name: CI Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test Bootstrap
    dependencies: []
    run:
      when: change_in('/bootstrap/')
    task:
      jobs:
        - commands:
            - checkout
            - cd bootstrap
            - go test service_test.go
            - go test reader_test.go
          name: Test Bootstrap
  - name: Test certs
    dependencies: []
    run:
      when: change_in('/certs/')
    task:
        
      jobs:
        - commands:
            - checkout
            - cd certs
            - go test certs_test.go
            - go test service_test.go
          name: Test certs
  - name: Test http
    dependencies: []
    run:
      when: change_in('/http/api/')
    task:
      jobs:
        - commands:
            - checkout
            - cd http/api
            - go test
          name: Nameless 1
  - name: Test logger
    dependencies: []
    run:
      when: change_in('/logger/')
    task:
      jobs:
        - commands:
            - checkout
            - cd logger
            - go test level_test.go
            - go test logger_test.go
          name: Logger test
  - name: Test lora
    dependencies: []
    run:
      when: change_in('/lora/')
    task:
      jobs:
        - commands:
            - checkout
            - cd lora
            - go test
          name: Nameless 1      
  - name: Test mqtt
    dependencies: []
    run:
      when: change_in('/mqtt/')
    task:
      jobs:
        - commands:
            - checkout
            - cd mqtt
            - go test
          name: Mqtt test    
  - name: Test things
    dependencies: []
    run:
      when: change_in('/things/')
    task:
      jobs:
        - commands:
            - checkout
            - cd things/
            - |
              find -type d | while read -r dir; do
                if [[ -n $(find "$dir" -name "_test.go" -type f)]]; then
                  echo "Running tests in directory: $dir"
                  (cd "$dir" && go test -v)
                fi
              done
          name: Test things         
  - name: Test users
    dependencies: []
    run:
      when: change_in('/users/')
    task:
      jobs:
        - commands:
            - checkout
            - cd users/
            - |
              find -type d | while read -r dir; do
                if [[ -n $(find "$dir" -name "_test.go" -type f)]]; then
                  echo "Running tests in directory: $dir"
                  (cd "$dir" && go test -v)
                fi
              done
          name: Test users     
  - name: Test twins
    dependencies: []
    run:
      when: change_in('/twins/')
    task:
      jobs:
        - commands:
            - checkout
            - cd twins/
            - |
              find -type d | while read -r dir; do
                if [[ -n $(find "$dir" -name "_test.go" -type f)]]; then
                  echo "Running tests in directory: $dir"
                  (cd "$dir" && go test -v)
                fi
              done
          name: Test twins        
  - name: Test ws
    dependencies: []
    run:
      when: change_in('/ws/')
    task:
      jobs:
        - commands:
            - checkout
            - cd ws/
            - |
              find -type d | while read -r dir; do
                if [[ -n $(find "$dir" -name "_test.go" -type f)]]; then
                  echo "Running tests in directory: $dir"
                  (cd "$dir" && go test -v)
                fi
              done
          name: Test ws                                          
  - name: Integration tests
    dependencies:
      - Test http
      - Test certs
    run:
      when: 'change_in([''/http/'', ''/certs/''])'
    task:
      jobs:
        - commands:
            - checkout
            - make test
          name: integration test
