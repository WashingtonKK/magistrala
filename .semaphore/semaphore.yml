version: v1.0
name: CI Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

auto_cancel:
  running:
    when: "branch != 'master'"

blocks:
  - name: Test Bootstrap
    dependencies: []
    run:
      when: change_in('/bootstrap/')
    task:
      jobs:
        - commands:
            - checkout
            - cd bootstrap
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test Bootstrap
  - name: Test certs
    dependencies: []
    run:
      when: change_in('/certs/')
    task:
      jobs:
        - commands:
            - checkout
            - cd certs
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test certs
  - name: Test http
    dependencies: []
    run:
      when: change_in('/http/')
    task:
      jobs:
        - commands:
            - checkout
            - cd http/api
            - go test -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test http
  - name: Test logger
    dependencies: []
    run:
      when: change_in('/logger/')
    task:
      jobs:
        - commands:
            - checkout
            - cd logger
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Logger test
  - name: Test consumers
    dependencies: []
    run:
      when: change_in('/consumers/')
    task:
      jobs:
        - commands:
            - checkout
            - cd consumers
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Consumers test          
  - name: Test all
    dependencies:
      - Lint
    run:
      when: "branch = 'master'"
    task:
      jobs:
        - commands:
            - checkout
            - make test
          name: All test

  - name: Test lora
    dependencies: []
    run:
      when: change_in('/lora/')
    task:
      jobs:
        - commands:
            - checkout
            - cd lora
            - go test -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test lora
  - name: Test mqtt
    dependencies: []
    run:
      when: change_in('/mqtt/')
    task:
      jobs:
        - commands:
            - checkout
            - cd mqtt
            - go test -v -coverprofile=coverage.out
            - go tool cover -html=coverage.out -o coverage.html 
          name: Mqtt test
  - name: Test proto
    dependencies: []
    # run:
    #   when:
    task:
      # env_vars:
      #   - name: GOPATH
      #     value: /usr/local/bin/go
      #   - name: PATH
      #     value: /usr/local/bin
      #   - name: PATH
      #     value: $PATH:/usr/local/bin/go/bin
      #   - name: GOBIN
      #     value: $GOPATH/bin
      #   - name: PATH
      #     value: $PATH:$GOBIN
      #   - name: PATH
      #     value: /bin:/usr/bin
      jobs:
        - commands:
            - export PATH=$PATH:/usr/local/bin/go/bin
            - export GOPATH=/usr/local/bin/go
            - export GOBIN=$GOPATH/bin
            - export PATH=$PATH:$GOBIN
            - NPROC=$(nproc)
            - PROTOC_VERSION=21.12
            - PROTOC_GEN_VERSION=v1.28.1
            - PROTOC_GRPC_VERSION=v1.2.0
            - checkout      
            - |
              function version_gt() {
                test "$(printf ''%s\n'' "$@" | sort -V | head -n 1)" != "$1"
              }            
            - echo "Setting up protoc..."
            - PROTOC_ZIP=protoc-$PROTOC_VERSION-linux-x86_64.zip
            - curl -0L https://github.com/google/protobuf/releases/download/v$PROTOC_VERSION/$PROTOC_ZIP -o $PROTOC_ZIP
            - ls
            - unzip -o $PROTOC_ZIP -d protoc3
            - ls
            - sudo mv protoc3/bin/* /usr/local/bin/
            - sudo mv protoc3/include/* /usr/local/include/
            - rm -f PROTOC_ZIP     
            - go install google.golang.org/protobuf/cmd/protoc-gen-go@$PROTOC_GEN_VERSION
            - go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@$PROTOC_GRPC_VERSION    
            - export PATH=$PATH:/usr/local/bin/protoc
            - |
              echo "Setting up Mainflux..."
              for p in $(ls *.pb.go); do
                  mv $p $p.tmp
              done
            - |
              for p in $(ls pkg/*/*.pb.go); do
                  mv $p $p.tmp
              done
            - make proto
            - |
              for p in $(ls *.pb.go); do
                  if ! cmp -s $p $p.tmp; then
                      echo "Proto file and generated Go file $p are out of sync!"
                      exit 1
                  fi
              done
            - |
              for p in $(ls pkg/*/*.pb.go); do
                  if ! cmp -s $p $p.tmp; then
                      echo "Proto file and generated Go file $p are out of sync!"
                      exit 1
                  fi
              done
            - echo "Compile check for rabbitmq..."
            - MF_BROKER_TYPE=rabbitmq make http
            - make -j$NPROC
          name: Proto test
  - name: Test things
    dependencies: []
    run:
      when: change_in('/things/')
    task:
      jobs:
        - commands:
            - checkout
            - cd things/
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test things
  - name: Test users
    dependencies: []
    run:
      when: change_in('/users/')
    task:
      jobs:
        - commands:
            - checkout
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html 
          name: Test users
  - name: Test twins
    dependencies: []
    run:
      when: change_in('/twins/')
    task:
      jobs:
        - commands:
            - checkout
            - cd twins/
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html            
          name: Test twins
  - name: Test ws
    dependencies: []
    run:
      when: change_in('/ws/')
    task:
      jobs:
        - commands:
            - checkout
            - cd ws/
            - go test -v -coverprofile=coverage.out ./...
            - go tool cover -html=coverage.out -o coverage.html            
          name: Test ws
  - name: Lint
    dependencies: []
    task:
      jobs:
        - commands:
            - |
              function version_gt() {
                test "$(printf ''%s\n'' "$@" | sort -V | head -n 1)" != "$1"
              }
            - export GOBIN=$HOME/go/bin
            - 'export PATH=$PATH:$GOBIN'
            - checkout
            - 'curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOBIN) $GOLANGCI_LINT_VERSION'
            - 'golangci-lint run --no-config --disable-all --enable gosimple,errcheck,govet,unused,goconst,godot --timeout 3m'
          name: Lint
      prologue:
        commands:
          - GOLANGCI_LINT_VERSION=v1.52.1
  - name: Integration tests
    dependencies:
      - Test http
      - Test certs
      - Test users
      - Test ws
      - Test twins
      - Test things
      - Test lora
      - Test Bootstrap
      - Test logger
      - Test mqtt
      - Test consumers
    run:
      when: 'change_in([''/http/'', ''/certs/'', ''/things/'', ''/users/''])'
    task:
      jobs:
        - commands:
            - checkout
            - NPROC=$(nproc) 
            - make all
            - make dockers
            - MF_BROKER_TYPE=rabbitmq make http
            - make -j$NPROC
            - |
              if test -n "$BRANCH_NAME" && test "$BRANCH_NAME"; then
                echo "pushing Docker images..."
                make -j$NPROC latest
            - make test
          name: integration test

